<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Project</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #debugInfo {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false;"
      loading-screen="enabled: true;"
      renderer="logarithmicDepthBuffer: true;"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      id="scene"
      embedded
      gesture-detector
    >
      <a-assets>
        <a-asset-item
          id="animated-asset"
          src="assets/animated.glb"
        ></a-asset-item>
        <a-asset-item id="static-asset" src="assets/head.glb"></a-asset-item>
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="assets/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
      >
        <a-entity
          id="static-model"
          scale="0.3 0.3 0.3"
          gltf-model="#static-asset"
          class="clickable"
          gesture-handler
          position="0 0 0"
          rotation="-90 0 0"
        ></a-entity>
        <a-entity
          id="bowser-model"
          scale="0.3 0.3 0.3"
          gltf-model="#animated-asset"
          class="clickable"
          gesture-handler
          position="0 0 0"
          rotation="-90 0 0"
        ></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
    <div id="debugInfo"></div>

    <script>
      const DEBUG = true;
      let animationSequenceStarted = false;

      function debug(message) {
        if (DEBUG) {
          console.log(message);
          document.getElementById("debugInfo").innerHTML += message + "<br>";
        }
      }

      class AnimationController {
        constructor() {
          this.staticModel = document.querySelector("#static-model");
          this.bowserModel = document.querySelector("#bowser-model");
        }

        init() {
          this.addEventListeners();
        }

        addEventListeners() {
          document.addEventListener("click", this.onClickHandler.bind(this));
          this.staticModel.addEventListener("model-loaded", () =>
            debug("Static model loaded")
          );
          this.bowserModel.addEventListener("model-loaded", () =>
            debug("Animated model loaded")
          );
        }

        onClickHandler() {
          if (!animationSequenceStarted) {
            debug("Click detected. Starting animation sequence...");
            this.startAnimationSequence();
            document.removeEventListener("click", this.onClickHandler);
          }
        }

        startAnimationSequence() {
          if (animationSequenceStarted) return;
          animationSequenceStarted = true;
          debug("Starting animation sequence...");
          this.playStaticModelAnimation();
        }

        playStaticModelAnimation() {
          if (!this.staticModel.hasAttribute("animation-mixer")) {
            this.staticModel.setAttribute("animation-mixer", {
              clip: "ArmatureAction",
              loop: "once",
              clampWhenFinished: true,
            });
          }

          const mixer = this.staticModel.components["animation-mixer"].mixer;
          if (mixer) {
            const clipAction = mixer.clipAction("ArmatureAction");
            if (clipAction) {
              debug("Playing ArmatureAction...");
              clipAction.reset();
              clipAction.setLoop(THREE.LoopOnce);
              clipAction.clampWhenFinished = true;
              clipAction.play();

              this.staticModel.addEventListener(
                "animation-finished",
                (event) => {
                  if (event.detail.action._clip.name === "ArmatureAction") {
                    debug(
                      "ArmatureAction finished. Starting BrainInside animation..."
                    );
                    this.animateBrainInside();
                  }
                },
                { once: true }
              );
            } else {
              debug("Error: ArmatureAction not found in the model");
            }
          } else {
            debug("Error: Mixer not found in animation-mixer component");
          }
        }

        animateBrainInside() {
          const brainInside =
            this.bowserModel.object3D.getObjectByName("BrainInside");
          if (brainInside) {
            debug("Animating BrainInside...");
            const initialY = brainInside.position.y;
            const startTime = Date.now();
            const duration = 1000;
            const animationDistance = 0.1;

            const animateUp = () => {
              const now = Date.now();
              const progress = (now - startTime) / duration;

              if (progress < 1) {
                brainInside.position.y =
                  initialY + progress * animationDistance;
                requestAnimationFrame(animateUp);
              } else {
                brainInside.position.y = initialY + animationDistance;
                debug(
                  "BrainInside animation completed. Starting animated-asset animations..."
                );
                this.playAllAnimationsOnAnimatedAsset();
              }
            };

            animateUp();
          } else {
            debug("Error: BrainInside object not found");
          }
        }

        playAllAnimationsOnAnimatedAsset() {
          if (!this.bowserModel.hasAttribute("animation-mixer")) {
            this.bowserModel.setAttribute("animation-mixer", "");
          }

          const mixer = this.bowserModel.components["animation-mixer"].mixer;
          if (mixer) {
            const animations =
              this.bowserModel.components["gltf-model"].model.animations;
            let totalDuration = 0;

            animations.forEach((clip, index) => {
              setTimeout(() => {
                debug(`Playing animation: ${clip.name}`);
                const action = mixer.clipAction(clip);
                action.setLoop(THREE.LoopRepeat);
                action.clampWhenFinished = true;
                action.reset();
                action.play();
              }, totalDuration * 1000);

              totalDuration += clip.duration;
            });

            setTimeout(() => {
              debug("All animations completed.");
            }, totalDuration * 1000);
          } else {
            debug("Error: Mixer not found for animated-asset");
          }
        }
      }

      // Initialize the animation controller when the scene is loaded
      document.querySelector("a-scene").addEventListener("loaded", () => {
        const controller = new AnimationController();
        controller.init();
      });
    </script>
  </body>
</html>
