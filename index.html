<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zappar-aframe/3.1.0/zappar-aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/2.7.0/webcomponents-loader.min.js"></script>
  </head>
  <body>
    <a-scene
      zappar
      loading-screen="enabled: true;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <a-assets>
        <a-asset-item
          id="animated-asset"
          src="assets/looped.glb"
        ></a-asset-item>
        <a-asset-item id="static-asset" src="assets/head.glb"></a-asset-item>
      </a-assets>

      <a-zap-target-marker type="pattern" target-src="assets/marker.patt">
        <a-entity
          id="static-model"
          scale="0.3 0.3 0.3"
          gltf-model="#static-asset"
          class="clickable"
          animation-mixer
        ></a-entity>
        <a-entity
          id="bowser-model"
          scale="0.3 0.3 0.3"
          gltf-model="#animated-asset"
          class="clickable"
          animation-mixer
        ></a-entity>
      </a-zap-target-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      let animationSequenceStarted = false;
      let bandFinalPosition;
      let bandAnimation;

      function addAnimationAndPlay() {
        if (animationSequenceStarted) return;
        animationSequenceStarted = true;

        console.log("Starting animation sequence...");
        const staticModel = document.querySelector("#static-model");
        const animatedModel = document.querySelector("#bowser-model");

        if (!staticModel || !animatedModel) {
          console.log("Error: Models not found");
          return;
        }

        startBandAnimation(animatedModel);
        playHeadOpeningAnimation(staticModel);
      }

      function startBandAnimation(animatedModel) {
        const mixer = animatedModel.components["animation-mixer"].mixer;
        if (mixer) {
          const animations =
            animatedModel.components["gltf-model"].model.animations;
          bandAnimation = animations.find((clip) => clip.name === "Band");

          if (bandAnimation) {
            console.log("Starting Band animation...");
            const action = mixer.clipAction(bandAnimation);
            action.setLoop(THREE.LoopRepeat);
            action.clampWhenFinished = false;
            action.reset();
            action.play();
          } else {
            console.log("Error: Band animation not found");
          }
        } else {
          console.log("Error: Mixer not found for animated-asset");
        }
      }

      function playHeadOpeningAnimation(el) {
        const mixer = el.components["animation-mixer"].mixer;
        if (mixer) {
          const clipAction = mixer.clipAction("ArmatureAction");
          if (clipAction) {
            console.log("Playing ArmatureAction...");
            clipAction.reset();
            clipAction.setLoop(THREE.LoopOnce);
            clipAction.clampWhenFinished = true;
            clipAction.play();

            el.addEventListener(
              "animation-finished",
              function animationFinishedHandler(event) {
                el.removeEventListener(
                  "animation-finished",
                  animationFinishedHandler
                );
                if (event.detail.action._clip.name === "ArmatureAction") {
                  console.log(
                    "ArmatureAction finished. Starting BrainInside animation..."
                  );
                  animateBrainInside();
                }
              }
            );
          } else {
            console.log("Error: ArmatureAction not found in the model");
          }
        } else {
          console.log("Error: Mixer not found in animation-mixer component");
        }
      }

      function animateBrainInside() {
        const bowserModel = document.querySelector("#bowser-model");
        const brainInside = bowserModel.object3D.getObjectByName("BrainInside");

        if (brainInside) {
          console.log("Animating BrainInside...");
          const initialY = brainInside.position.y;
          const startTime = Date.now();
          const duration = 1000;
          const animationDistance = 0.1;

          function animateUp() {
            const now = Date.now();
            const progress = (now - startTime) / duration;

            if (progress < 1) {
              brainInside.position.y = initialY + progress * animationDistance;
              requestAnimationFrame(animateUp);
            } else {
              bandFinalPosition = new THREE.Vector3(
                brainInside.position.x,
                initialY + animationDistance,
                brainInside.position.z
              );
              console.log(
                "BrainInside animation completed. Starting remaining animations..."
              );
              playRemainingAnimations();
            }
          }

          animateUp();
        } else {
          console.log("Error: BrainInside object not found");
        }
      }

      function playRemainingAnimations() {
        const animatedModel = document.querySelector("#bowser-model");
        const mixer = animatedModel.components["animation-mixer"].mixer;
        if (mixer) {
          const animations =
            animatedModel.components["gltf-model"].model.animations;

          animations.forEach((clip) => {
            if (clip.name !== "Band") {
              // Skip the Band animation as it's already playing
              console.log(`Playing animation: ${clip.name}`);
              const action = mixer.clipAction(clip);
              action.setLoop(THREE.LoopRepeat);
              action.clampWhenFinished = false;
              action.reset();
              action.play();
            }
          });

          console.log("All remaining animations started simultaneously.");

          // Add a render loop to constantly update the band's position
          function renderLoop() {
            const brainInside =
              animatedModel.object3D.getObjectByName("BrainInside");
            if (brainInside && bandFinalPosition) {
              brainInside.position.copy(bandFinalPosition);
            }
            requestAnimationFrame(renderLoop);
          }
          renderLoop();
        } else {
          console.log("Error: Mixer not found for animated-asset");
        }
      }

      document.addEventListener("click", () => {
        addAnimationAndPlay();
      });
    </script>
  </body>
</html>
