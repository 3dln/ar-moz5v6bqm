<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Project</title>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-detector.js"></script>
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    <style>
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      .a-scene {
        width: 100vw; /* Full viewport width */
        height: 100vh; /* Full viewport height */
        position: fixed; /* Fixed to the viewport */
        top: 0;
        left: 0;
        margin: 0; /* Remove default margin */
        padding: 0; /* Remove default padding */
        transform: none !important; /* Ensure no transformation is applied */
        z-index: 0 !important; /* Ensure it stays beneath other elements */
      }
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        pointer-events: none;
      }
      #debugInfo {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        font-family: monospace;
        pointer-events: auto;
      }
      #zombieButton {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        font-size: 18px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-family: "Creepster", cursive;
        text-transform: uppercase;
        letter-spacing: 2px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        pointer-events: auto;
      }
      #zombieButton:hover {
        background-color: #45a049;
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        transform: translateX(-50%) translateY(-2px);
      }
      #zombieButton:active {
        background-color: #3e8e41;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transform: translateX(-50%) translateY(1px);
      }
    </style>
    <link
      href="https://fonts.googleapis.com/css2?family=Creepster&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false;"
      loading-screen="enabled: false;"
      renderer="logarithmicDepthBuffer: true;"
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      id="scene"
      embedded
      gesture-detector
    >
      <a-assets>
        <a-asset-item
          id="animated-asset"
          src="assets/animated.glb"
        ></a-asset-item>
        <a-asset-item id="static-asset" src="assets/head.glb"></a-asset-item>
      </a-assets>

      <a-marker
        id="animated-marker"
        type="pattern"
        preset="custom"
        url="assets/marker.patt"
        raycaster="objects: .clickable"
        emitevents="true"
        cursor="fuse: false; rayOrigin: mouse;"
      >
        <a-entity
          id="static-model"
          scale="0.3 0.3 0.3"
          gltf-model="#static-asset"
          class="clickable"
          gesture-handler
          position="0 0 0"
          rotation="-90 0 0"
        ></a-entity>
        <a-entity
          id="bowser-model"
          scale="0.3 0.3 0.3"
          gltf-model="#animated-asset"
          class="clickable"
          gesture-handler
          position="0 0 0"
          rotation="-90 0 0"
        ></a-entity>
      </a-marker>
      <a-entity camera></a-entity>
    </a-scene>
    <div id="overlay">
      <div id="debugInfo"></div>
      <button id="zombieButton">Click for Surprise</button>
    </div>

    <script>
      const PRODUCTION = false; // Set this to true for production
      const DEBUG = !PRODUCTION;
      let animationSequenceStarted = false;

      function debug(message) {
        if (DEBUG) {
          console.log(message);
          document.getElementById("debugInfo").innerHTML += message + "<br>";
        }
      }

      class AnimationController {
        constructor() {
          this.staticModel = document.querySelector("#static-model");
          this.bowserModel = document.querySelector("#bowser-model");
          this.zombieButton = document.getElementById("zombieButton");
        }

        init() {
          this.addEventListeners();
          this.setupDebugVisibility();
        }

        setupDebugVisibility() {
          const debugInfo = document.getElementById("debugInfo");
          debugInfo.style.display = DEBUG ? "block" : "none";
        }

        addEventListeners() {
          this.zombieButton.addEventListener(
            "click",
            this.onZombieButtonClick.bind(this)
          );
          this.staticModel.addEventListener("model-loaded", () =>
            debug("Static model loaded")
          );
          this.bowserModel.addEventListener("model-loaded", () =>
            debug("Animated model loaded")
          );
        }

        onZombieButtonClick() {
          if (!animationSequenceStarted) {
            debug("Zombie button clicked. Starting animation sequence...");
            this.startAnimationSequence();
            this.zombieButton.style.display = "none"; // Hide the button after clicking
          }
        }

        startAnimationSequence() {
          if (animationSequenceStarted) return;
          animationSequenceStarted = true;
          debug("Starting animation sequence...");
          this.playStaticModelAnimation();
        }

        playStaticModelAnimation() {
          if (!this.staticModel.hasAttribute("animation-mixer")) {
            this.staticModel.setAttribute("animation-mixer", {
              clip: "ArmatureAction",
              loop: "once",
              clampWhenFinished: true,
            });
          }

          const mixer = this.staticModel.components["animation-mixer"].mixer;
          if (mixer) {
            const clipAction = mixer.clipAction("ArmatureAction");
            if (clipAction) {
              debug("Playing ArmatureAction...");
              clipAction.reset();
              clipAction.setLoop(THREE.LoopOnce);
              clipAction.clampWhenFinished = true;
              clipAction.play();

              this.staticModel.addEventListener(
                "animation-finished",
                (event) => {
                  if (event.detail.action._clip.name === "ArmatureAction") {
                    debug(
                      "ArmatureAction finished. Starting BrainInside animation..."
                    );
                    this.animateBrainInside();
                  }
                },
                { once: true }
              );
            } else {
              debug("Error: ArmatureAction not found in the model");
            }
          } else {
            debug("Error: Mixer not found in animation-mixer component");
          }
        }

        animateBrainInside() {
          const brainInside =
            this.bowserModel.object3D.getObjectByName("BrainInside");
          if (brainInside) {
            debug("Animating BrainInside...");
            const initialY = brainInside.position.y;
            const startTime = Date.now();
            const duration = 1000;
            const animationDistance = 0.1;

            const animateUp = () => {
              const now = Date.now();
              const progress = (now - startTime) / duration;

              if (progress < 1) {
                brainInside.position.y =
                  initialY + progress * animationDistance;
                requestAnimationFrame(animateUp);
              } else {
                brainInside.position.y = initialY + animationDistance;
                debug(
                  "BrainInside animation completed. Starting animated-asset animations..."
                );
                this.playAllAnimationsOnAnimatedAsset();
              }
            };

            animateUp();
          } else {
            debug("Error: BrainInside object not found");
          }
        }

        playAllAnimationsOnAnimatedAsset() {
          if (!this.bowserModel.hasAttribute("animation-mixer")) {
            this.bowserModel.setAttribute("animation-mixer", "");
          }

          const mixer = this.bowserModel.components["animation-mixer"].mixer;
          if (mixer) {
            const animations =
              this.bowserModel.components["gltf-model"].model.animations;
            let totalDuration = 0;

            animations.forEach((clip, index) => {
              setTimeout(() => {
                debug(`Playing animation: ${clip.name}`);
                const action = mixer.clipAction(clip);
                action.setLoop(THREE.LoopRepeat);
                action.clampWhenFinished = true;
                action.reset();
                action.play();
              }, totalDuration * 1000);

              totalDuration += clip.duration;
            });

            setTimeout(() => {
              debug("All animations completed.");
            }, totalDuration * 1000);
          } else {
            debug("Error: Mixer not found for animated-asset");
          }
        }
      }

      // Initialize the animation controller when the scene is loaded
      document.querySelector("a-scene").addEventListener("loaded", () => {
        const controller = new AnimationController();
        controller.init();
      });
    </script>
  </body>
</html>
